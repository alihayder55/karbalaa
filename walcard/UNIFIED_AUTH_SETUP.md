# دليل النظام الموحد لتسجيل الدخول والتسجيل - ولكارد

## المفهوم الجديد

تم إنشاء نظام موحد يجمع بين تسجيل الدخول وإنشاء الحساب في واجهة واحدة:

### كيف يعمل النظام:

1. **المستخدم يدخل رقم هاتفه**
2. **النظام يتحقق من وجود الحساب**
3. **إذا كان الحساب موجود**: يظهر واجهة تسجيل الدخول
4. **إذا كان حساب جديد**: يظهر واجهة إنشاء الحساب
5. **بعد التحقق من OTP**: يتم توجيه المستخدم حسب حالته

## هيكل قاعدة البيانات الجديد

### جدول المستخدمين الأساسي (profiles)
```sql
- id: UUID (مرتبط بـ auth.users)
- full_name: النام الكامل
- phone_number: رقم الهاتف (فريد)
- user_type: نوع المستخدم ('merchant' أو 'store_owner')
- avatar_url: رابط الصورة الشخصية
- created_at, updated_at: تواريخ الإنشاء والتحديث
```

### جدول التجار (merchants)
```sql
- id: SERIAL
- user_id: UUID (مرتبط بـ profiles.id)
- business_name: اسم النشاط التجاري
- chamber_of_commerce_id: رقم غرفة التجارة
- available_products: مصفوفة المنتجات
- is_approved: حالة الموافقة
- created_at, updated_at: تواريخ
```

### جدول أصحاب المحلات (store_owners)
```sql
- id: SERIAL
- user_id: UUID (مرتبط بـ profiles.id)
- address: عنوان المحل
- nearest_landmark: أقرب معلم
- latitude, longitude: إحداثيات
- store_type: نوع المحل
- storefront_image: صورة الواجهة
- is_approved: حالة الموافقة
- created_at, updated_at: تواريخ
```

## الملفات الجديدة

### 1. سكريبت قاعدة البيانات الموحد
```
walcard/supabase-setup-unified.sql
```

### 2. واجهة المصادقة الموحدة
```
walcard/app/auth/unified-auth.tsx
```

## المميزات الجديدة

### 1. **فحص تلقائي للمستخدمين**
```sql
-- دالة للتحقق من وجود المستخدم ونوع حسابه
get_user_account_info(phone_input TEXT)
```

### 2. **ربط تلقائي بين الجداول**
- عند إنشاء حساب تاجر، يتم تحديث `user_type` إلى 'merchant'
- عند إنشاء حساب صاحب محل، يتم تحديث `user_type` إلى 'store_owner'

### 3. **أمان محسن**
- كل مستخدم مرتبط بـ user_id فريد
- Row Level Security مفعل على جميع الجداول
- صلاحيات محددة لكل مستخدم

## تدفق العمل الجديد

### للمستخدمين الجدد:
1. **إدخال رقم الهاتف** → التحقق من عدم وجود الحساب
2. **إدخال الاسم الكامل** → إرسال OTP
3. **التحقق من OTP** → إنشاء حساب أساسي في `profiles`
4. **اختيار نوع الحساب** → تاجر أو صاحب محل
5. **ملء بيانات التخصص** → إنشاء سجل في الجدول المناسب
6. **انتظار الموافقة الإدارية**

### للمستخدمين الحاليين:
1. **إدخال رقم الهاتف** → التحقق من وجود الحساب
2. **عرض بيانات المستخدم** → اسم ونوع الحساب
3. **إرسال OTP** → تسجيل الدخول مباشرة

## خطوات التطبيق

### 1. تحديث قاعدة البيانات
```sql
-- تنفيذ السكريبت الجديد
-- File: supabase-setup-unified.sql
```

### 2. استخدام الواجهة الجديدة
```tsx
// استبدال شاشات login.tsx و register.tsx
// بـ unified-auth.tsx
```

### 3. تحديث navigation
```tsx
// توجيه المستخدمين إلى unified-auth بدلاً من login/register
```

## الفوائد

### 1. **تجربة مستخدم محسنة**
- واجهة واحدة للجميع
- تحديد تلقائي لنوع العملية
- تقليل الخطوات المطلوبة

### 2. **أمان أفضل**
- ربط محكم بين الجداول
- منع التلاعب في البيانات
- صلاحيات دقيقة

### 3. **إدارة أسهل**
- هيكل موحد للبيانات
- تتبع أفضل للمستخدمين
- صيانة أقل

## الدوال المساعدة الجديدة

### 1. فحص المستخدم
```sql
get_user_account_info(phone_input TEXT)
-- ترجع: has_account, user_type, is_approved, full_name
```

### 2. تحديث نوع المستخدم
```sql
update_user_type_on_account_creation()
-- تحديث تلقائي عند إنشاء حساب تجاري
```

## اختبار النظام

### 1. مستخدم جديد
```
1. ادخل رقم هاتف جديد
2. تأكد من ظهور واجهة "إنشاء حساب جديد"
3. ادخل الاسم وأكمل التسجيل
4. تحقق من إنشاء السجلات في الجداول
```

### 2. مستخدم موجود
```
1. ادخل رقم هاتف موجود
2. تأكد من ظهور واجهة "مرحباً بك مرة أخرى"
3. تحقق من عرض البيانات الصحيحة
4. أكمل تسجيل الدخول
```

### 3. حساب غير مفعل
```
1. ادخل رقم هاتف لحساب غير مفعل
2. تأكد من ظهور رسالة "حساب غير مفعل"
3. تحقق من منع المتابعة
```

## نصائح التطوير

### 1. إدارة الحالات
- تأكد من معالجة جميع حالات المستخدمين
- اضبط رسائل الخطأ المناسبة
- اختبر السيناريوهات المختلفة

### 2. الأمان
- لا تعتمد على البيانات من العميل فقط
- استخدم user_id من الخادم
- تحقق من الصلاحيات دائماً

### 3. الأداء
- استخدم الفهارس المناسبة
- احذف الاستعلامات غير الضرورية
- راقب أداء الدوال

## الصيانة

### 1. مراقبة منتظمة
- تحقق من سجلات الأخطاء
- راقب أداء قاعدة البيانات
- تابع استخدام المستخدمين

### 2. النسخ الاحتياطية
- نسخ احتياطية منتظمة للبيانات
- اختبار استعادة البيانات
- توثيق إجراءات الطوارئ

### 3. التحديثات
- تحديث مكتبات الأمان
- مراجعة الصلاحيات دورياً
- تحسين الاستعلامات عند الحاجة 