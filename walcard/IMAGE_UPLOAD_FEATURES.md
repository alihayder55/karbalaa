# ميزات رفع الصور في Walcard

## نظرة عامة

تم إضافة ميزة رفع الصور إلى Supabase Storage في تطبيق Walcard. هذه الميزة تسمح للمستخدمين برفع صور المتاجر والهويات والوثائق التجارية.

## الملفات المضافة/المحدثة

### 1. `lib/supabase-storage.ts`
- ملف جديد لإدارة رفع الصور إلى Supabase Storage
- يحتوي على دوال لرفع أنواع مختلفة من الصور
- يدعم رفع الصور إلى مجلدات منفصلة حسب النوع

### 2. `supabase-storage-setup.sql`
- سكريبت SQL لإعداد Supabase Storage
- إنشاء bucket `forstore`
- إعداد سياسات الأمان (RLS)
- إنشاء الوظائف المطلوبة

### 3. `STORAGE_SETUP.md`
- دليل شامل لإعداد Supabase Storage
- خطوات التكوين والاختبار
- استكشاف الأخطاء

### 4. صفحات التسجيل المحدثة
- `app/auth/store-owner-registration.tsx`
- `app/auth/merchant-registration.tsx`

## أنواع الصور المدعومة

### 1. صور المتاجر (Store Images)
- **المجلد**: `store-images/{user_id}/`
- **الاستخدام**: صور واجهات المتاجر
- **الوصول**: عام (يمكن للعملاء رؤيتها)
- **الحد الأقصى**: 50MB

### 2. صور الهوية (Identity Images)
- **المجلد**: `identity-images/{user_id}/`
- **الاستخدام**: صور الهوية للتحقق
- **الوصول**: خاص (للمستخدم فقط)
- **الحد الأقصى**: 50MB

### 3. صور الأعمال (Business Images)
- **المجلد**: `business-images/{user_id}/`
- **الاستخدام**: صور متعلقة بالأعمال التجارية
- **الوصول**: خاص (للمستخدم فقط)
- **الحد الأقصى**: 50MB

### 4. صور متاجر التجار (Merchant Store Images)
- **المجلد**: `merchant-store-images/{user_id}/`
- **الاستخدام**: صور متاجر التجار
- **الوصول**: عام (يمكن للعملاء رؤيتها)
- **الحد الأقصى**: 50MB

## الدوال المتاحة

### `uploadImageToStorage(imageUri, bucketName, folderPath, fileName)`
- دالة عامة لرفع الصور
- تدعم جميع أنواع الصور
- تعيد رابط الصورة العامة

### `uploadStoreImage(imageUri, userId)`
- مخصصة لرفع صور المتاجر
- تنشئ مجلد منفصل لكل مستخدم
- تعيد رابط الصورة العامة

### `uploadIdentityImage(imageUri, userId)`
- مخصصة لرفع صور الهوية
- محمية بسياسات أمان خاصة
- تعيد رابط الصورة العامة

### `uploadBusinessImage(imageUri, userId)`
- مخصصة لرفع صور الأعمال
- محمية بسياسات أمان خاصة
- تعيد رابط الصورة العامة

### `uploadMerchantStoreImage(imageUri, userId)`
- مخصصة لرفع صور متاجر التجار
- متاحة للجمهور للعرض
- تعيد رابط الصورة العامة

## تنسيقات الصور المدعومة

- JPEG (.jpg, .jpeg)
- PNG (.png)
- WebP (.webp)
- HEIC (.heic)

## ميزات الأمان

### 1. Row Level Security (RLS)
- جميع الصور محمية بـ RLS
- كل مستخدم يمكنه الوصول فقط لصوره
- استثناء: صور المتاجر متاحة للجمهور

### 2. سياسات الوصول
- **المستخدمين العاديين**: رفع وعرض وتحديث وحذف صورهم
- **الجمهور**: عرض صور المتاجر فقط
- **المشرفين**: وصول كامل لجميع الصور

### 3. التحقق من الأذونات
- التحقق من تسجيل الدخول قبل الرفع
- التحقق من نوع الملف
- التحقق من حجم الملف

## كيفية الاستخدام

### في صفحة تسجيل صاحب المحل:
1. المستخدم يختار صورة المتجر
2. الصورة تُعرض كمعاينة
3. عند إرسال النموذج، تُرفع الصورة تلقائياً
4. يتم حفظ رابط الصورة في قاعدة البيانات

### في صفحة تسجيل التاجر:
1. المستخدم يختار صورة الهوية
2. الصورة تُعرض كمعاينة
3. عند إرسال النموذج، تُرفع الصورة تلقائياً
4. يتم حفظ رابط الصورة في قاعدة البيانات

## معالجة الأخطاء

### أخطاء الرفع:
- إذا فشل رفع الصورة، يتم عرض تحذير
- يستمر التسجيل بدون الصورة
- يتم تسجيل الخطأ في console

### أخطاء الأذونات:
- التحقق من أذونات الكاميرا والمعرض
- عرض رسائل خطأ واضحة
- توجيه المستخدم لإعداد الأذونات

### أخطاء الشبكة:
- التحقق من الاتصال قبل الرفع
- إعادة المحاولة في حالة الفشل
- رسائل خطأ واضحة للمستخدم

## التطوير المستقبلي

### ميزات مقترحة:
1. **ضغط الصور**: تقليل حجم الصور تلقائياً
2. **تحرير الصور**: أدوات تحرير بسيطة
3. **معاينة متعددة**: رفع عدة صور في نفس الوقت
4. **حذف الصور**: إمكانية حذف الصور المرفوعة
5. **نسخ احتياطي**: نسخ احتياطي تلقائي للصور

### تحسينات الأداء:
1. **رفع تدريجي**: رفع الصور في الخلفية
2. **تخزين مؤقت**: تخزين مؤقت للصور المحملة
3. **تحسين الشبكة**: استخدام WebP للصور
4. **ضغط ذكي**: ضغط الصور حسب نوع الاستخدام

## الاختبار

### اختبار الرفع:
1. اختيار صورة من المعرض
2. التقاط صورة بالكاميرا
3. رفع صور بأحجام مختلفة
4. اختبار أنواع ملفات مختلفة

### اختبار الأمان:
1. محاولة الوصول لصور مستخدم آخر
2. اختبار سياسات RLS
3. اختبار الأذونات

### اختبار الأداء:
1. رفع صور كبيرة
2. اختبار سرعة الرفع
3. اختبار استهلاك البيانات 